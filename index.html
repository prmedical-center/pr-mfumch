<!doctype html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå - MFU Medical Center</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Kanit', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); background-attachment: fixed; }
    .day-cell { min-height: 80px; @media (min-width: 768px) { min-height: 110px; } transition: 0.2s; background: #fff; border: 1px solid #f3f4f6; }
    .today { border: 2px solid #4f46e5 !important; background-color: #eef2ff; }
    .event-badge { font-size: 9px; padding: 2px 4px; border-radius: 4px; margin-top: 2px; background: #4f46e5; color: white; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .booked { background-color: #fee2e2; }
    .pr-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .pr-item { display: flex; gap: 12px; align-items: center; padding: 12px 16px; background: white; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
  </style>
</head>
<body class="h-full gradient-bg p-3 md:p-8">
  <div class="max-w-6xl mx-auto">
    <div class="max-w-4xl mx-auto mb-8">
      <section class="pr-grid">
        <div class="pr-item"><span class="text-2xl">üé®</span><div><strong class="text-blue-800 text-sm block">‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏¥‡∏ï‡∏™‡∏∑‡πà‡∏≠</strong><span class="text-[11px] text-gray-500">10‚Äì20 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</span></div></div>
        <div class="pr-item"><span class="text-2xl">üì∏</span><div><strong class="text-blue-800 text-sm block">‡∏Å‡∏≤‡∏£‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</strong><span class="text-[11px] text-gray-500">‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå 30 ‡∏ß‡∏±‡∏ô</span></div></div>
      </section>
    </div>

    <div class="flex justify-center mb-6">
      <div class="bg-black/20 p-1 rounded-full flex gap-1 border border-white/10">
        <button onclick="showTab('book')" id="btn-book" class="px-6 py-2 rounded-full text-sm font-medium bg-white text-indigo-600 shadow-lg transition-all">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà</button>
        <button onclick="showTab('list')" id="btn-list" class="px-6 py-2 rounded-full text-sm font-medium text-white hover:bg-white/10 transition-all">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</button>
      </div>
    </div>

    <div id="book-section" class="bg-white rounded-[2rem] shadow-2xl p-6 md:p-10">
      <form onsubmit="handleSubmit(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="text-sm font-semibold text-gray-600">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô *</label><input type="text" name="coordinator_name" required class="w-full px-4 py-3 rounded-xl border outline-none focus:ring-2 focus:ring-indigo-400"></div>
        <div><label class="text-sm font-semibold text-gray-600">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô *</label><input type="text" name="department" required class="w-full px-4 py-3 rounded-xl border outline-none focus:ring-2 focus:ring-indigo-400"></div>
        <div class="md:col-span-2">
            <label class="text-sm font-semibold text-gray-600 block mb-2">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ *</label>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 bg-gray-50 p-4 rounded-xl border border-dashed">
                <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="services" value="‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏™‡∏∑‡πà‡∏≠"> ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏™‡∏∑‡πà‡∏≠</label>
                <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="services" value="‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û"> ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</label>
            </div>
        </div>
        <div><label class="text-sm font-semibold text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô *</label><input type="date" name="preferred_date" required class="w-full px-4 py-3 rounded-xl border"></div>
        <div><label class="text-sm font-semibold text-gray-600">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ *</label><div class="flex gap-2"><input type="time" name="start_time" required class="w-full p-3 rounded-xl border"><span>-</span><input type="time" name="end_time" required class="w-full p-3 rounded-xl border"></div></div>
        <button type="submit" id="submit-btn" class="md:col-span-2 bg-indigo-600 text-white font-bold py-4 rounded-2xl hover:bg-indigo-700 transition-all">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</button>
      </form>
    </div>

    <div id="list-section" class="hidden bg-white rounded-[2rem] shadow-2xl p-4 md:p-8">
      <div class="flex justify-between items-center mb-6">
        <h2 id="calendar-month" class="text-xl font-bold text-gray-800 uppercase"></h2>
        <div class="flex gap-2">
          <button onclick="changeMonth(-1)" class="px-4 py-2 border rounded-lg hover:bg-gray-50">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
          <button onclick="changeMonth(1)" class="px-4 py-2 border rounded-lg hover:bg-gray-50">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <div id="calendar-grid" class="grid grid-cols-7 min-w-[600px] bg-gray-200 border border-gray-200 rounded-xl overflow-hidden shadow-inner">
          <div class="bg-indigo-600 text-white py-2 text-center text-[10px] font-bold">‡∏≠‡∏≤</div><div class="bg-indigo-600 text-white py-2 text-center text-[10px] font-bold">‡∏à</div><div class="bg-indigo-600 text-white py-2 text-center text-[10px] font-bold">‡∏≠</div><div class="bg-indigo-600 text-white py-2 text-center text-[10px] font-bold">‡∏û</div><div class="bg-indigo-600 text-white py-2 text-center text-[10px] font-bold">‡∏û‡∏§</div><div class="bg-indigo-600 text-white py-2 text-center text-[10px] font-bold">‡∏®</div><div class="bg-indigo-600 text-white py-2 text-center text-[10px] font-bold">‡∏™</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwBNjqWX1uj6cKX29C0N-UpfZLcZLoq4RfzYNXw1WE8meLz1wnLuzEf2teAd0qJBsFc/exec";
    let appointments = [];
    let currentMonth = new Date();

    function showTab(tab) {
      document.getElementById('book-section').classList.toggle('hidden', tab !== 'book');
      document.getElementById('list-section').classList.toggle('hidden', tab === 'book');
      if(tab === 'list') fetchData();
    }

    async function handleSubmit(e) {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = {
        coordinator_name: fd.get('coordinator_name'),
        department: fd.get('department'),
        preferred_date: fd.get('preferred_date'),
        time_range: `${fd.get('start_time')} - ${fd.get('end_time')}`,
        services: Array.from(e.target.querySelectorAll('input[name="services"]:checked')).map(c => c.value).join(', ')
      };
      
      const btn = document.getElementById('submit-btn');
      btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";
      
      try {
        await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        e.target.reset();
        showTab('list');
      } catch (err) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
      finally { btn.disabled = false; btn.innerText = "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß"; }
    }

    async function fetchData() {
      try {
        const res = await fetch(WEB_APP_URL);
        appointments = await res.json();
        renderCalendar();
      } catch (err) { console.error("Fetch error"); }
    }

    function renderCalendar() {
      const grid = document.getElementById('calendar-grid');
      const monthLabel = document.getElementById('calendar-month');
      grid.querySelectorAll('.day-cell').forEach(d => d.remove());
      
      monthLabel.textContent = currentMonth.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });
      const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay();
      const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
      const todayStr = new Date().toLocaleDateString('en-CA');

      for (let i = 0; i < firstDay; i++) {
        const empty = document.createElement('div'); empty.className = "day-cell bg-gray-50";
        grid.appendChild(empty);
      }

      for (let d = 1; d <= daysInMonth; d++) {
        const year = currentMonth.getFullYear();
        const month = String(currentMonth.getMonth() + 1).padStart(2, '0');
        const day = String(d).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;
        
        const event = appointments.find(a => a.preferred_date === dateStr);
        const cell = document.createElement('div');
        cell.className = `day-cell p-1 md:p-2 ${event ? 'booked' : ''} ${dateStr === todayStr ? 'today' : ''}`;
        cell.innerHTML = `<div class="text-[10px] font-bold ${dateStr === todayStr ? 'text-indigo-600' : 'text-gray-400'}">${d}</div>`;
        
        if (event) {
          const b = document.createElement('div'); b.className = "event-badge"; b.innerText = `‚è∞ ${event.preferred_time}`; cell.appendChild(b);
          const t = document.createElement('div'); t.className = "text-[8px] truncate text-indigo-700 mt-1"; t.innerText = event.event_title; cell.appendChild(t);
        }
        grid.appendChild(cell);
      }
    }
    function changeMonth(s) { currentMonth.setMonth(currentMonth.getMonth() + s); renderCalendar(); }
    fetchData();
  </script>
</body>
</html>
